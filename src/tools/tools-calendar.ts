//lines 701 - 804 from index.tz